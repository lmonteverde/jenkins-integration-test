pipeline {
    agent any
    
    environment {
        // POSTMAN_API_KEY = 'PMAT-01HEWT0J6H22HWG6P0TPK0WXRA'
        POSTMAN_API_KEY = 'JK_PM_API_KEY'
    }

    stages {
        stage('Run Postman Collection') {
            steps {
                script {
                    // Imprime las versiones de Node.js y Newman
                    sh 'node -v'
                    sh 'newman -v'

                    // Ejecuta la colecci√≥n de Postman con Newman y el reporter HTML Extra
                    sh 'newman run https://api.postman.com/collections/21778326-1c7662b4-aaa6-4015-a141-fffe960486aa?access_key=$POSTMAN_API_KEY --reporters cli,htmlextra'
                }
            }
        }
    }

    post {
        always {
            // Archiva los resultados del reporter HTML Extra
            archiveArtifacts artifacts: 'newman/**/*', allowEmptyArchive: true
        }

        success {
            // Publica los informes HTML en Jenkins
            publishHTML([
                allowMissing: false,
                alwaysLinkToLastBuild: false,
                keepAll: true,
                reportDir: 'newman',
                reportFiles: 'API_Testing-*.html',
                reportName: 'Postman Collection Report'
            ])

            echo 'Postman collection run successful!'
        }

        failure {
            echo 'Postman collection run failed!'
        }
    }
}
