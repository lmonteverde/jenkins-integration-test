pipeline {
    agent any
    
    environment {
        JK_PM_API_KEY = credentials('JK_PM_API_KEY')
    }

    stages {
        stage('Run Postman Collection') {
            steps {
                script {
                    def POSTMAN_API_KEY = env.JK_PM_API_KEY
                    // Imprime las versiones de Node.js y Newman
                    sh 'node -v'
                    sh 'newman -v'

                    // Ejecuta la colecci√≥n de Postman con Newman y el reporter HTML Extra
                    // sh 'newman run https://api.postman.com/collections/21778326-1c7662b4-aaa6-4015-a141-fffe960486aa?access_key=${POSTMAN_API_KEY} --reporters cli,htmlextra'
                    sh "newman run 'https://api.postman.com/collections/21778326-1c7662b4-aaa6-4015-a141-fffe960486aa?access_key=${POSTMAN_API_KEY}' --reporters cli,htmlextra"
            }
        }
    }

    post {
        always {
            // Archiva los resultados del reporter HTML Extra
            archiveArtifacts artifacts: 'newman/**/*', allowEmptyArchive: true
        }

        success {
            // Publica los informes HTML en Jenkins
            publishHTML([
                allowMissing: false,
                alwaysLinkToLastBuild: false,
                keepAll: true,
                reportDir: 'newman',
                reportFiles: 'API_Testing-*.html',
                reportName: 'Postman Collection Report'
            ])

            echo 'Postman collection run successful!'
        }

        failure {
            echo 'Postman collection run failed!'
        }
    }
}
